"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _eventemitter = _interopRequireDefault(require("eventemitter3"));

var _debug = _interopRequireDefault(require("debug"));

var _rateLimiter = require("@dutu/rate-limiter");

var _priorityQueue = require("./priorityQueue.js");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const dbg_exec = (0, _debug.default)('tq:exec');

class ThrottledQueue extends _eventemitter.default {
  constructor({
    rateLimiter,
    maxConcurrent = 1,
    minDelay = 0,
    timeout = 0
  }) {
    super();

    if (!(rateLimiter instanceof _rateLimiter.RollingWindowLimiter || rateLimiter instanceof _rateLimiter.FixedWindowLimiter || rateLimiter instanceof _rateLimiter.TokenBucketLimiter)) {
      throw new Error('rateLimiter must be instanceof RateLimiter');
    }

    this._pauseUntil = 0;
    this._running = 0;
    this._options = {
      maxConcurrent,
      minDelay,
      timeout
    };
    this._timeoutId = null;
    this._limiter = rateLimiter;
    this._lastExecuted = 0;
    this._priorityQueue = new _priorityQueue.PriorityQueue();

    this._priorityQueue.on('enqueue', (element, priority) => this.emit('enqueue', element.options.id, priority));

    this._priorityQueue.on('dequeue', (element, priority) => this.emit('dequeue', element.options.id, priority));
  }

  async next() {
    if (this._pauseUntil === null) {
      clearTimeout(this._timeoutId);
      return;
    }

    if (this._pauseUntil > 0) {
      clearTimeout(this._timeoutId);
      this._timeoutId = setTimeout(this.start.bind(this), Math.max(0, this._pauseUntil - Date.now()));
      return;
    }

    if (this._options.minDelay && this._lastExecuted && Date.now() - this._lastExecuted < this._options.minDelay) {
      clearTimeout(this._timeoutId);
      this._timeoutId = setTimeout(this.next.bind(this), Date.now() - this._lastExecuted - this._options.minDelay);
      return;
    }

    if (this._priorityQueue.size > 0) {
      if (this._running < this._options.maxConcurrent) {
        if (this._limiter.tryRemoveTokens(1)) {
          this._running += 1;

          const job = this._priorityQueue.dequeue();

          const options = Object.assign({}, this._options, job.options);

          if (options.timeout) {
            job.timeoutId = setTimeout(() => {
              const reject = job.reject;
              delete job.resolve;
              delete job.reject;
              const error = new Error(`timeout after ${options.timeout} ms`);
              this.emit('failed', error, job.options.id);
              reject(error);
              this._running -= 1;
              this.next();
            }, options.timeout);
          }

          this.emit('execute', job.options.id);
          this._lastExecuted = Date.now();
          dbg_exec(job.options.id);
          job.func().then(result => {
            if (job.timeoutId) clearTimeout(job.timeoutId);

            if (job.resolve) {
              this.emit('done', result, job.options.id);
              job.resolve(result);
            }
          }).catch(err => {
            if (job.timeoutId) clearTimeout(job.timeoutId);

            if (job.reject) {
              this.emit('failed', err, job.options.id);
              job.reject(err);
            }
          }).finally(() => {
            if (job.resolve) {
              this._running -= 1;
              this.next();
            }
          });
          this.next();
        } else {
          const delayMS = this._limiter.getDelayForTokens(1);

          clearTimeout(this._timeoutId);
          this._timeoutId = setTimeout(this.next.bind(this), delayMS);
        }
      }
    }
  }

  async add({
    id,
    priority = 5,
    timeout
  } = {}, func) {
    return new Promise((resolve, reject) => {
      const newJob = {
        options: {
          id
        },
        func,
        resolve,
        reject
      };

      if (timeout) {
        newJob.options.timeout = timeout;
      }

      this._priorityQueue.enqueue(newJob, priority);

      if (this._priorityQueue.size === 1) {
        this.next();
      }
    });
  }

  pause(durationMs) {
    if (durationMs === null) {
      this._pauseUntil = null;
    } else {
      this._pauseUntil = Date.now() + durationMs;
    }
  }

  start() {
    this._pauseUntil = 0;
    clearTimeout(this._timeoutId);
    this._timeoutId = setTimeout(this.next.bind(this), 0);
  }

  getSize(priority = undefined) {
    return this._priorityQueue.getSize(priority);
  }

  clear() {
    this._priorityQueue.clear();
  }

}

exports.default = ThrottledQueue;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy90aHJvdHRsZWRRdWV1ZS5tanMiXSwibmFtZXMiOlsiZGJnX2V4ZWMiLCJUaHJvdHRsZWRRdWV1ZSIsIkV2ZW50RW1pdHRlciIsImNvbnN0cnVjdG9yIiwicmF0ZUxpbWl0ZXIiLCJtYXhDb25jdXJyZW50IiwibWluRGVsYXkiLCJ0aW1lb3V0IiwiUm9sbGluZ1dpbmRvd0xpbWl0ZXIiLCJGaXhlZFdpbmRvd0xpbWl0ZXIiLCJUb2tlbkJ1Y2tldExpbWl0ZXIiLCJFcnJvciIsIl9wYXVzZVVudGlsIiwiX3J1bm5pbmciLCJfb3B0aW9ucyIsIl90aW1lb3V0SWQiLCJfbGltaXRlciIsIl9sYXN0RXhlY3V0ZWQiLCJfcHJpb3JpdHlRdWV1ZSIsIlByaW9yaXR5UXVldWUiLCJvbiIsImVsZW1lbnQiLCJwcmlvcml0eSIsImVtaXQiLCJvcHRpb25zIiwiaWQiLCJuZXh0IiwiY2xlYXJUaW1lb3V0Iiwic2V0VGltZW91dCIsInN0YXJ0IiwiYmluZCIsIk1hdGgiLCJtYXgiLCJEYXRlIiwibm93Iiwic2l6ZSIsInRyeVJlbW92ZVRva2VucyIsImpvYiIsImRlcXVldWUiLCJPYmplY3QiLCJhc3NpZ24iLCJ0aW1lb3V0SWQiLCJyZWplY3QiLCJyZXNvbHZlIiwiZXJyb3IiLCJmdW5jIiwidGhlbiIsInJlc3VsdCIsImNhdGNoIiwiZXJyIiwiZmluYWxseSIsImRlbGF5TVMiLCJnZXREZWxheUZvclRva2VucyIsImFkZCIsIlByb21pc2UiLCJuZXdKb2IiLCJlbnF1ZXVlIiwicGF1c2UiLCJkdXJhdGlvbk1zIiwiZ2V0U2l6ZSIsInVuZGVmaW5lZCIsImNsZWFyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxRQUFRLEdBQUcsb0JBQU0sU0FBTixDQUFqQjs7QUFFZSxNQUFNQyxjQUFOLFNBQTZCQyxxQkFBN0IsQ0FBMEM7QUFDdkRDLEVBQUFBLFdBQVcsQ0FBQztBQUFFQyxJQUFBQSxXQUFGO0FB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cnQgRXZlbnRFbWl0dGVyIGZyb20gJ2V2ZW50ZW1pdHRlcjMnXHJcbmltcG9ydCBEZWJ1ZyBmcm9tICdkZWJ1ZydcclxuaW1wb3J0IHsgUm9sbGluZ1dpbmRvd0xpbWl0ZXIsIEZpeGVkV2luZG93TGltaXRlciwgVG9rZW5CdWNrZXRMaW1pdGVyIH0gZnJvbSAnQGR1dHUvcmF0ZS1saW1pdGVyJ1xyXG5pbXBvcnQgeyBQcmlvcml0eVF1ZXVlIH0gZnJvbSAnLi9wcmlvcml0eVF1ZXVlLmpzJ1xyXG5cclxuY29uc3QgZGJnX2V4ZWMgPSBEZWJ1ZygndHE6ZXhlYycpXHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBUaHJvdHRsZWRRdWV1ZSBleHRlbmRzIEV2ZW50RW1pdHRlciB7XHJcbiAgY29uc3RydWN0b3IoeyByYXRlTGltaXRlciwgbWF4Q29uY3VycmVudCA9IDEsIG1pbkRlbGF5ID0gMCwgdGltZW91dCA9IDAgfSkge1xyXG4gICAgc3VwZXIoKVxyXG4gICAgaWYgKCEocmF0ZUxpbWl0ZXIgaW5zdGFuY2VvZiBSb2xsaW5nV2luZG93TGltaXRlciB8fCByYXRlTGltaXRlciBpbnN0YW5jZW9mIEZpeGVkV2luZG93TGltaXRlciB8fCByYXRlTGltaXRlciBpbnN0YW5jZW9mIFRva2VuQnVja2V0TGltaXRlcikpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdyYXRlTGltaXRlciBtdXN0IGJlIGluc3RhbmNlb2YgUmF0ZUxpbWl0ZXInKVxyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuX3BhdXNlVW50aWwgPSAwXHJcbiAgICB0aGlzLl9ydW5uaW5nID0gMFxyXG4gICAgdGhpcy5fb3B0aW9ucyA9IHtcclxuICAgICAgbWF4Q29uY3VycmVudCxcclxuICAgICAgbWluRGVsYXksXHJcbiAgICAgIHRpbWVvdXQsXHJcbiAgICB9XHJcblxyXG5cclxuICAgIHRoaXMuX3RpbWVvdXRJZCA9IG51bGxcclxuICAgIHRoaXMuX2xpbWl0ZXIgPSByYXRlTGltaXRlclxyXG4gICAgdGhpcy5fbGFzdEV4ZWN1dGVkID0gMFxyXG4gICAgdGhpcy5fcHJpb3JpdHlRdWV1ZSA9IG5ldyBQcmlvcml0eVF1ZXVlKClcclxuICAgIHRoaXMuX3ByaW9yaXR5UXVldWUub24oJ2VucXVldWUnLCAoZWxlbWVudCwgcHJpb3JpdHkpID0+IHRoaXMuZW1pdCgnZW5xdWV1ZScsIGVsZW1lbnQub3B0aW9ucy5pZCwgcHJpb3JpdHkpKVxyXG4gICAgdGhpcy5fcHJpb3JpdHlRdWV1ZS5vbignZGVxdWV1ZScsIChlbGVtZW50LCBwcmlvcml0eSkgPT4gdGhpcy5lbWl0KCdkZXF1ZXVlJywgZWxlbWVudC5vcHRpb25zLmlkLCBwcmlvcml0eSkpXHJcbiAgfVxyXG5cclxuICBhc3luYyBuZXh0KCkge1xyXG4gICAgaWYgKHRoaXMuX3BhdXNlVW50aWwgPT09IG51bGwpIHtcclxuICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVvdXRJZClcclxuICAgICAgcmV0dXJuXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMuX3BhdXNlVW50aWwgPiAwKSB7XHJcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLl90aW1lb3V0SWQpXHJcbiAgICAgIHRoaXMuX3RpbWVvdXRJZCA9IHNldFRpbWVvdXQodGhpcy5zdGFydC5iaW5kKHRoaXMpLCBNYXRoLm1heCgwLCB0aGlzLl9wYXVzZVVudGlsIC0gRGF0ZS5ub3coKSkpXHJcbiAgICAgIHJldHVyblxyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLl9vcHRpb25zLm1pbkRlbGF5ICYmIHRoaXMuX2xhc3RFeGVjdXRlZCAmJiAoRGF0ZS5ub3coKSAtIHRoaXMuX2xhc3RFeGVjdXRlZCA8IHRoaXMuX29wdGlvbnMubWluRGVsYXkpKSB7XHJcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLl90aW1lb3V0SWQpXHJcbiAgICAgIHRoaXMuX3RpbWVvdXRJZCA9IHNldFRpbWVvdXQodGhpcy5uZXh0LmJpbmQodGhpcyksIERhdGUubm93KCkgLSB0aGlzLl9sYXN0RXhlY3V0ZWQgLSB0aGlzLl9vcHRpb25zLm1pbkRlbGF5KVxyXG4gICAgICByZXR1cm5cclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5fcHJpb3JpdHlRdWV1ZS5zaXplID4gMCkge1xyXG4gICAgICBpZiAodGhpcy5fcnVubmluZyA8IHRoaXMuX29wdGlvbnMubWF4Q29uY3VycmVudCkge1xyXG4gICAgICAgIGlmICh0aGlzLl9saW1pdGVyLnRyeVJlbW92ZVRva2VucygxKSkge1xyXG4gICAgICAgICAgdGhpcy5fcnVubmluZyArPSAxXHJcbiAgICAgICAgICBjb25zdCBqb2IgPSB0aGlzLl9wcmlvcml0eVF1ZXVlLmRlcXVldWUoKVxyXG4gICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuX29wdGlvbnMsIGpvYi5vcHRpb25zKVxyXG4gICAgICAgICAgaWYgKG9wdGlvbnMudGltZW91dCkge1xyXG4gICAgICAgICAgICBqb2IudGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgY29uc3QgcmVqZWN0ID0gam9iLnJlamVjdFxyXG4gICAgICAgICAgICAgIGRlbGV0ZSBqb2IucmVzb2x2ZVxyXG4gICAgICAgICAgICAgIGRlbGV0ZSBqb2IucmVqZWN0XHJcbiAgICAgICAgICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoYHRpbWVvdXQgYWZ0ZXIgJHtvcHRpb25zLnRpbWVvdXR9IG1zYClcclxuICAgICAgICAgICAgICB0aGlzLmVtaXQoJ2ZhaWxlZCcsIGVycm9yLCBqb2Iub3B0aW9ucy5pZClcclxuICAgICAgICAgICAgICByZWplY3QoZXJyb3IpXHJcbiAgICAgICAgICAgICAgdGhpcy5fcnVubmluZyAtPSAxXHJcbiAgICAgICAgICAgICAgdGhpcy5uZXh0KClcclxuICAgICAgICAgICAgfSwgb3B0aW9ucy50aW1lb3V0KVxyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIHRoaXMuZW1pdCgnZXhlY3V0ZScsIGpvYi5vcHRpb25zLmlkKVxyXG4gICAgICAgICAgdGhpcy5fbGFzdEV4ZWN1dGVkID0gRGF0ZS5ub3coKVxyXG4gICAgICAgICAgZGJnX2V4ZWMoam9iLm9wdGlvbnMuaWQpXHJcbiAgICAgICAgICBqb2IuZnVuYygpXHJcbiAgICAgICAgICAgIC50aGVuKChyZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgICBpZiAoam9iLnRpbWVvdXRJZCkgY2xlYXJUaW1lb3V0KGpvYi50aW1lb3V0SWQpXHJcbiAgICAgICAgICAgICAgaWYgKGpvYi5yZXNvbHZlKXtcclxuICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgnZG9uZScsIHJlc3VsdCwgam9iLm9wdGlvbnMuaWQpXHJcbiAgICAgICAgICAgICAgICBqb2IucmVzb2x2ZShyZXN1bHQpXHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuY2F0Y2goKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgIGlmIChqb2IudGltZW91dElkKSBjbGVhclRpbWVvdXQoam9iLnRpbWVvdXRJZClcclxuICAgICAgICAgICAgICBpZiAoam9iLnJlamVjdCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdmYWlsZWQnLCBlcnIsIGpvYi5vcHRpb25zLmlkKVxyXG4gICAgICAgICAgICAgICAgam9iLnJlamVjdChlcnIpXHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuZmluYWxseSgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgaWYgKGpvYi5yZXNvbHZlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9ydW5uaW5nIC09IDFcclxuICAgICAgICAgICAgICAgIHRoaXMubmV4dCgpXHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG5cclxuICAgICAgICAgIHRoaXMubmV4dCgpXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGNvbnN0IGRlbGF5TVMgPSB0aGlzLl9saW1pdGVyLmdldERlbGF5Rm9yVG9rZW5zKDEpXHJcbiAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fdGltZW91dElkKVxyXG4gICAgICAgICAgdGhpcy5fdGltZW91dElkID0gc2V0VGltZW91dCh0aGlzLm5leHQuYmluZCh0aGlzKSwgZGVsYXlNUylcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIGFkZCh7IGlkLCBwcmlvcml0eSA9IDUsIHRpbWVvdXQgfSA9IHt9LCBmdW5jKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBjb25zdCBuZXdKb2IgPSB7XHJcbiAgICAgICAgb3B0aW9ucyA6IHsgaWQgfSxcclxuICAgICAgICBmdW5jLFxyXG4gICAgICAgIHJlc29sdmUsXHJcbiAgICAgICAgcmVqZWN0XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmICh0aW1lb3V0KSB7XHJcbiAgICAgICAgbmV3Sm9iLm9wdGlvbnMudGltZW91dCA9IHRpbWVvdXRcclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy5fcHJpb3JpdHlRdWV1ZS5lbnF1ZXVlKG5ld0pvYiwgcHJpb3JpdHkpXHJcbiAgICAgIGlmICh0aGlzLl9wcmlvcml0eVF1ZXVlLnNpemUgPT09IDEpIHtcclxuICAgICAgICB0aGlzLm5leHQoKVxyXG4gICAgICB9XHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgcGF1c2UoZHVyYXRpb25Ncykge1xyXG4gICAgaWYgKGR1cmF0aW9uTXMgPT09IG51bGwpIHtcclxuICAgICAgdGhpcy5fcGF1c2VVbnRpbCA9IG51bGxcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuX3BhdXNlVW50aWwgPSBEYXRlLm5vdygpICsgZHVyYXRpb25Nc1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgc3RhcnQoKSB7XHJcbiAgICB0aGlzLl9wYXVzZVVudGlsID0gMFxyXG4gICAgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVvdXRJZClcclxuICAgIHRoaXMuX3RpbWVvdXRJZCA9IHNldFRpbWVvdXQodGhpcy5uZXh0LmJpbmQodGhpcyksIDApXHJcbiAgfVxyXG5cclxuICBnZXRTaXplKHByaW9yaXR5ID0gdW5kZWZpbmVkKSB7XHJcbiAgICByZXR1cm4gdGhpcy5fcHJpb3JpdHlRdWV1ZS5nZXRTaXplKHByaW9yaXR5KVxyXG4gIH1cclxuXHJcbiAgY2xlYXIoKSB7XHJcbiAgICB0aGlzLl9wcmlvcml0eVF1ZXVlLmNsZWFyKClcclxuICB9XHJcbn1cclxuIl19